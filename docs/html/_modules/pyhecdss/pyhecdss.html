
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>pyhecdss.pyhecdss &#8212; pyhecdss 0.5.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyhecdss.pyhecdss</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pyheclib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="c1"># some static functions</span>

<span class="n">DATE_FMT_STR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%Y&#39;</span>

<div class="viewcode-block" id="set_message_level"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.set_message_level">[docs]</a><span class="k">def</span> <span class="nf">set_message_level</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set the verbosity level of the HEC-DSS library</span>
<span class="sd">    level ranges from &quot;bort&quot; only (level 0) to &quot;internal&quot; (level &gt;10)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zset</span><span class="p">(</span><span class="s1">&#39;MLEVEL&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_program_name"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.set_program_name">[docs]</a><span class="k">def</span> <span class="nf">set_program_name</span><span class="p">(</span><span class="n">program_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sets the name of the program (upto 6 chars long) to store with data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">program_name</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">program_name</span><span class="p">))]</span>
    <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zset</span><span class="p">(</span><span class="s1">&#39;PROGRAM&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_version"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.get_version">[docs]</a><span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get version of DSS File</span>
<span class="sd">    returns a tuple of string version of 4 characters and integer version</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zfver</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_rts"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.get_rts">[docs]</a><span class="k">def</span> <span class="nf">get_rts</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pathname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets regular time series matching the pathname from the filename.</span>
<span class="sd">    Opens and reads pathname from filename and then closes it (slightly inefficient)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    filename: a path to DSS file</span>
<span class="sd">    pathname: a string of the form /A/B/C/D/E/F that is parsed to match all parts except D</span>
<span class="sd">    which if not blank is used to determine the time window to retrieve</span>
<span class="sd">    D should be specified in the format of ddMMMYYYY HHmm - ddMMMYYYY HHmm</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    a list of tuple (pandas DataFrame, units, period type) for timeseries found or an empty list</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Assumes that all matching are Regular time series ( as opposed to Irregular, See DSS terminolog)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Get time series based on a part of pathname, e.g.</span>

<span class="sd">    &gt;&gt;&gt; pyhecdss.get_rts(&#39;test1.dss&#39;, &#39;//SIN/////&#39;)</span>
<span class="sd">    [(rts,units,type),...]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dssh</span><span class="o">=</span><span class="n">DSSFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">dfcat</span><span class="o">=</span><span class="n">dssh</span><span class="o">.</span><span class="n">read_catalog</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pp</span><span class="o">=</span><span class="n">pathname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">cond</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">pp</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfcat</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">==</span><span class="n">p</span><span class="p">)</span>
        <span class="n">plist</span><span class="o">=</span><span class="n">dssh</span><span class="o">.</span><span class="n">get_pathnames</span><span class="p">(</span><span class="n">dfcat</span><span class="p">[</span><span class="n">cond</span><span class="p">])</span>
        <span class="n">twstr</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">pp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">startDateStr</span><span class="o">=</span><span class="n">endDateStr</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">twstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">twstr</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span><span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">twstr</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">startDateStr</span><span class="o">=</span><span class="n">twstr</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dssh</span><span class="o">.</span><span class="n">read_rts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plist</span><span class="p">]</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">dssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="DSSFile"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile">[docs]</a><span class="k">class</span> <span class="nc">DSSFile</span><span class="p">:</span>
    <span class="c1"># DSS missing conventions</span>
    <span class="n">MISSING_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mf">901.0</span>
    <span class="n">MISSING_RECORD</span> <span class="o">=</span> <span class="o">-</span><span class="mf">902.0</span>
    <span class="n">FREQ_EPART_MAP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;1MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> <span class="s2">&quot;2MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span> <span class="s2">&quot;3MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> <span class="s2">&quot;4MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span> <span class="s2">&quot;5MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span> <span class="s2">&quot;10MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span> <span class="s2">&quot;15MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span> <span class="s2">&quot;20MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Minute</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span> <span class="s2">&quot;30MIN&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;1HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> <span class="s2">&quot;2HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span> <span class="s2">&quot;3HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> <span class="s2">&quot;4HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span> <span class="s2">&quot;6HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span> <span class="s2">&quot;8HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span> <span class="s2">&quot;12HOUR&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;1DAY&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Week</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;1WEEK&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;1MON&quot;</span><span class="p">,</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">YearEnd</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="s2">&quot;1YEAR&quot;</span>
    <span class="p">}</span>
    <span class="n">EPART_FREQ_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">FREQ_EPART_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1">#</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    vectorized version of timedelta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timedelta_minutes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_dir_exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">intArray</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">istat</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_dir_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dname</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dname</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;Attempt to create file: </span><span class="si">%s</span><span class="s2"> in non-existent directory: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dname</span><span class="p">))</span>

<div class="viewcode-block" id="DSSFile.open"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open DSS file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isopen</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DSSFile.close"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close DSS File</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: remove all created arrays and pointers</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isopen</span><span class="p">):</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">zclose_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DSSFile.get_version"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.get_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get version of DSS File</span>
<span class="sd">        returns a tuple of string version of 4 characters and integer version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># needs to be done on a closed file</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isopen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zfver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="DSSFile.catalog"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.catalog">[docs]</a>    <span class="k">def</span> <span class="nf">catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Catalog DSS Files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opened_already</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opened_already</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="n">icunit</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>  <span class="c1"># unit (fortran) for catalog</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">intp_assign</span><span class="p">(</span><span class="n">icunit</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">fcname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span><span class="o">+</span><span class="s2">&quot;.dsc&quot;</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranopen_</span><span class="p">(</span><span class="n">icunit</span><span class="p">,</span> <span class="n">fcname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fcname</span><span class="p">))</span>
            <span class="n">icdunit</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>  <span class="c1"># unit (fortran) for condensed catalog</span>
            <span class="n">fdname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span><span class="o">+</span><span class="s2">&quot;.dsd&quot;</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">intp_assign</span><span class="p">(</span><span class="n">icdunit</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranopen_</span><span class="p">(</span><span class="n">icdunit</span><span class="p">,</span> <span class="n">fdname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdname</span><span class="p">))</span>
            <span class="n">inunit</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>
            <span class="c1"># new catalog, if non-zero no cataloging</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">intp_assign</span><span class="p">(</span><span class="n">inunit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">cinstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># catalog instructions : None = &quot;&quot;</span>
            <span class="n">labrev</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">intp_assign</span><span class="p">(</span><span class="n">labrev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 0 is unabbreviated.</span>
            <span class="n">ldsort</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">intp_assign</span><span class="p">(</span><span class="n">ldsort</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 1 is sorted</span>
            <span class="n">lcdcat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>  <span class="c1"># output if condensed created</span>
            <span class="n">nrecs</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">new_intp</span><span class="p">()</span>  <span class="c1"># number of records cataloged</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">zcat_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">,</span> <span class="n">icunit</span><span class="p">,</span> <span class="n">icdunit</span><span class="p">,</span> <span class="n">inunit</span><span class="p">,</span> <span class="n">cinstr</span><span class="p">,</span>
                           <span class="n">labrev</span><span class="p">,</span> <span class="n">ldsort</span><span class="p">,</span> <span class="n">lcdcat</span><span class="p">,</span> <span class="n">nrecs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cinstr</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">intp_value</span><span class="p">(</span><span class="n">nrecs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1">#warnings.warn(&quot;Exception occurred while catalogging&quot;)</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranflush_</span><span class="p">(</span><span class="n">icunit</span><span class="p">)</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranclose_</span><span class="p">(</span><span class="n">icunit</span><span class="p">)</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranflush_</span><span class="p">(</span><span class="n">icdunit</span><span class="p">)</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranclose_</span><span class="p">(</span><span class="n">icdunit</span><span class="p">)</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranflush_</span><span class="p">(</span><span class="n">inunit</span><span class="p">)</span>
            <span class="n">pyheclib</span><span class="o">.</span><span class="n">fortranclose_</span><span class="p">(</span><span class="n">inunit</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opened_already</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DSSFile.read_catalog"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.read_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">read_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads .dsd (condensed catalog) for the given dss file.</span>
<span class="sd">        Will run catalog if it doesn&#39;t exist or is out of date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fdname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)]</span><span class="o">+</span><span class="s2">&quot;.dsd&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fdname</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO CATALOG FOUND: Generating...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">):</span>
                <span class="n">ftime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)))</span>
                <span class="n">fdtime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fdname</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">ftime</span> <span class="o">&gt;</span> <span class="n">fdtime</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CATALOG FILE OLD: Generating...&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No DSS File found. Using catalog file as is&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fdname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tag&#39;</span><span class="p">,</span> <span class="s1">&#39;A Part&#39;</span><span class="p">,</span> <span class="s1">&#39;B Part&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;C Part&#39;</span><span class="p">,</span> <span class="s1">&#39;F Part&#39;</span><span class="p">,</span> <span class="s1">&#39;E Part&#39;</span><span class="p">,</span> <span class="s1">&#39;D Part&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: catalog is empty! for filename: &quot;</span><span class="p">,</span> <span class="n">fdname</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">colline</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">column_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">column_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colline</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;U132&#39;</span><span class="p">)</span>
        <span class="n">ilx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">9</span><span class="p">:]:</span>
            <span class="n">cix</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">isx</span> <span class="o">=</span> <span class="n">column_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">iex</span> <span class="ow">in</span> <span class="n">column_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">isx</span><span class="p">:</span><span class="n">iex</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">cix</span><span class="p">,</span> <span class="n">ilx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">a</span><span class="p">[</span><span class="n">cix</span><span class="p">,</span> <span class="n">ilx</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="n">cix</span> <span class="o">=</span> <span class="n">cix</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">isx</span> <span class="o">=</span> <span class="n">iex</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">isx</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">a</span><span class="p">[</span><span class="n">cix</span><span class="p">,</span> <span class="n">ilx</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">ilx</span> <span class="o">=</span> <span class="n">ilx</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;TABCFED&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DSSFile.get_pathnames"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.get_pathnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_pathnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">catalog_dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        converts a catalog data frame into pathnames</span>
<span class="sd">        If catalog_dataframe is None then reads catalog to populate it</span>

<span class="sd">        returns a list of pathnames (condensed version, i.e. D part is time window)</span>
<span class="sd">        /A PART/B PART/C PART/DPART (START DATE &quot;-&quot; END DATE)/E PART/F PART/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">catalog_dataframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">catalog_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_catalog</span><span class="p">()</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">catalog_dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">pdf</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

<div class="viewcode-block" id="DSSFile.num_values_in_interval"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.num_values_in_interval">[docs]</a>    <span class="k">def</span> <span class="nf">num_values_in_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdstr</span><span class="p">,</span> <span class="n">edstr</span><span class="p">,</span> <span class="n">istr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get number of values in interval istr, using the start date and end date</span>
<span class="sd">        string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">td</span><span class="o">=</span><span class="n">DSSFile</span><span class="o">.</span><span class="n">_get_timedelta_for_interval</span><span class="p">(</span><span class="n">istr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">parse</span><span class="p">(</span><span class="n">edstr</span><span class="p">)</span><span class="o">-</span><span class="n">parse</span><span class="p">(</span><span class="n">sdstr</span><span class="p">))</span><span class="o">/</span><span class="n">td</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span></div>

<div class="viewcode-block" id="DSSFile.julian_day"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.julian_day">[docs]</a>    <span class="k">def</span> <span class="nf">julian_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get julian day for the date. (count of days since beginning of year)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">dayofyear</span></div>

<div class="viewcode-block" id="DSSFile.m2ihm"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.m2ihm">[docs]</a>    <span class="k">def</span> <span class="nf">m2ihm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minute</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        24 hour style from mins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ihr</span> <span class="o">=</span> <span class="n">minute</span><span class="o">/</span><span class="mi">60</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">minute</span><span class="o">-</span><span class="p">(</span><span class="n">ihr</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">itime</span> <span class="o">=</span> <span class="n">ihr</span><span class="o">*</span><span class="mi">100</span><span class="o">+</span><span class="n">imin</span>
        <span class="k">return</span> <span class="n">itime</span></div>

<div class="viewcode-block" id="DSSFile.parse_pathname_epart"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.parse_pathname_epart">[docs]</a>    <span class="k">def</span> <span class="nf">parse_pathname_epart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathname</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pathname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_number_between</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is just a guess at number of values to be read so going over is ok.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">((</span><span class="n">parse</span><span class="p">(</span><span class="n">endDateStr</span><span class="p">)</span><span class="o">-</span><span class="n">parse</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">))</span><span class="o">/</span><span class="n">delta</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_timedelta_for_interval</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get minimum timedelta for interval defined by string. e.g. for month it is 28 days (minimum)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MON&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># less number of estimates will lead to overestimating values</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;YEAR&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">td</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">DSSFile</span><span class="o">.</span><span class="n">EPART_FREQ_MAP</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span><span class="o">.</span><span class="n">nanos</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">td</span>

    <span class="k">def</span> <span class="nf">_pad_to_end_of_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="n">edate</span><span class="o">=</span><span class="n">parse</span><span class="p">(</span><span class="n">endDateStr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MON&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;YEAR&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">edate</span><span class="o">=</span><span class="n">datetime</span><span class="p">((</span><span class="n">edate</span><span class="o">.</span><span class="n">year</span><span class="o">//</span><span class="mi">10</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">edate</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">edate</span><span class="o">.</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;HOUR&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">interval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;MIN&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edate</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">edate</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">edate</span><span class="o">.</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edate</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">edate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">edate</span><span class="o">.</span><span class="n">month</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edate</span> <span class="o">=</span> <span class="n">edate</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">edate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">DATE_FMT_STR</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_istat_for_zrrtsxd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">istat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C        ISTAT:   Integer status parameter, indicating the</span>
<span class="sd">        C                 successfullness of the retrieval.</span>
<span class="sd">        C                 ISTAT = 0  All ok.</span>
<span class="sd">        C                 ISTAT = 1  Some missing data (still ok)</span>
<span class="sd">        C                 ISTAT = 2  Missing data blocks, but some data found</span>
<span class="sd">        C                 ISTAT = 3  Combination of 1 and 2 (some data found)</span>
<span class="sd">        C                 ISTAT = 4  No data found, although a pathname was read</span>
<span class="sd">        C                 ISTAT = 5  No pathname(s) found</span>
<span class="sd">        C                 ISTAT &gt; 9  Illegal call to ZRRTS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;All good&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ISTAT: </span><span class="si">%d</span><span class="s2"> --&gt; &quot;</span> <span class="o">%</span> <span class="n">istat</span>
        <span class="k">if</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;Some missing data (still ok)&quot;</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;Missing data blocks, but some data found&quot;</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;Combination of 1 and 2 (some data found)&quot;</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;No data found, although a pathname was read&quot;</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;No pathname(s) found&quot;</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;Illegal call to ZRRTS&quot;</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span> <span class="nf">_respond_to_istat_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">istat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># everything is ok</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Some data or data blocks are missing [istat=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">istat</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Found file but failed to load any data&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># should this be an exception?</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Path not found&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">istat</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="c1"># should this be an exception?</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Illegal internal call&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_parse_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">startDateStr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endDateStr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        parse times based on pathname or startDateStr and endDateStr</span>
<span class="sd">        start date and end dates may be padded to include a larger interval</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pathname_epart</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">startDateStr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">endDateStr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">twstr</span> <span class="o">=</span> <span class="n">pathname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">twstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">twstr</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;No start date or end date and twstr is &quot;</span><span class="o">+</span><span class="n">twstr</span><span class="p">)</span>
                <span class="n">sdate</span> <span class="o">=</span> <span class="n">edate</span> <span class="o">=</span> <span class="n">twstr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sdate</span><span class="p">,</span> <span class="n">edate</span> <span class="o">=</span> <span class="n">twstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">startDateStr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">startDateStr</span> <span class="o">=</span> <span class="n">sdate</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">endDateStr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">endDateStr</span> <span class="o">=</span> <span class="n">edate</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">endDateStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pad_to_end_of_block</span><span class="p">(</span>
                    <span class="n">endDateStr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span>

<div class="viewcode-block" id="DSSFile.read_rts"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.read_rts">[docs]</a>    <span class="k">def</span> <span class="nf">read_rts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">startDateStr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endDateStr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read regular time series for pathname.</span>
<span class="sd">        if pathname D part contains a time window (START DATE &quot;-&quot; END DATE) and</span>
<span class="sd">        either start or end date is None it uses that to define start and end date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opened_already</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opened_already</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pathname_epart</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
            <span class="n">trim_first</span> <span class="o">=</span> <span class="n">startDateStr</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">trim_last</span> <span class="o">=</span> <span class="n">endDateStr</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_times</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">)</span>
            <span class="n">nvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_values_in_interval</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">sdate</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">)</span>
            <span class="n">cdate</span> <span class="o">=</span> <span class="n">sdate</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">ctime</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sdate</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1"># PERF: could be np.empty if all initialized</span>
            <span class="n">dvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nvals</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">nvals</span><span class="p">,</span> <span class="n">cunits</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">iofset</span><span class="p">,</span> <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zrrtsxd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">cdate</span><span class="p">,</span> <span class="n">ctime</span><span class="p">,</span>
                                                                       <span class="n">dvalues</span><span class="p">)</span>
            <span class="c1"># FIXME: raise appropriate exception for istat value</span>
            <span class="c1"># if istat != 0:</span>
            <span class="c1">#    raise Exception(self._get_istat_for_zrrtsxd(istat))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_respond_to_istat_state</span><span class="p">(</span><span class="n">istat</span><span class="p">)</span>

            <span class="c1"># FIXME: deal with non-zero iofset for period data,i.e. else part of if stmt below</span>
            <span class="n">freqoffset</span> <span class="o">=</span> <span class="n">DSSFile</span><span class="o">.</span><span class="n">EPART_FREQ_MAP</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ctype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;INST&#39;</span><span class="p">):</span>
                <span class="n">startDateWithOffset</span><span class="o">=</span><span class="n">parse</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">iofset</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">startDateWithOffset</span><span class="o">=</span><span class="n">parse</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">)</span><span class="o">-</span><span class="n">freqoffset</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">iofset</span><span class="p">)</span>
                <span class="n">dindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                    <span class="n">startDateWithOffset</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">nvals</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqoffset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqoffset</span><span class="p">)</span> <span class="o">-</span> \
                    <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">frequencies</span><span class="o">.</span><span class="n">to_offset</span><span class="p">(</span><span class="n">freqoffset</span><span class="p">)</span>
                <span class="n">dindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">nvals</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freqoffset</span><span class="p">)</span>
            <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dvalues</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dindex</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">pathname</span><span class="p">])</span>
            <span class="c1"># cleanup missing values --&gt; NAN, trim dataset and units and period type strings</span>
            <span class="n">df1</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">DSSFile</span><span class="o">.</span><span class="n">MISSING_VALUE</span><span class="p">,</span> <span class="n">DSSFile</span><span class="o">.</span><span class="n">MISSING_RECORD</span><span class="p">],</span> <span class="p">[</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trim_first</span> <span class="ow">or</span> <span class="n">trim_last</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trim_first</span><span class="p">:</span>
                    <span class="n">first_index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">first_valid_index</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">first_index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">trim_last</span><span class="p">:</span>
                    <span class="n">last_index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">last_valid_index</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">first_index</span><span class="p">:</span><span class="n">last_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span>
            <span class="k">return</span> <span class="n">df1</span><span class="p">,</span> <span class="n">cunits</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">ctype</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opened_already</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="DSSFile.write_rts"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.write_rts">[docs]</a>    <span class="k">def</span> <span class="nf">write_rts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cunits</span><span class="p">,</span> <span class="n">ctype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        write time series to this DSS file with the given pathname.</span>
<span class="sd">        The time series is passed in as a pandas DataFrame</span>
<span class="sd">        and associated units and types of length no greater than 8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">pathname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">DSSFile</span><span class="o">.</span><span class="n">FREQ_EPART_MAP</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">freq</span><span class="p">]</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zsrtsxd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span>
                                     <span class="n">sp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">%b%Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span>
                                     <span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M&quot;</span><span class="p">),</span>
                                     <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">cunits</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="n">ctype</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_respond_to_istat_state</span><span class="p">(</span><span class="n">istat</span><span class="p">)</span></div>

<div class="viewcode-block" id="DSSFile.read_its"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.read_its">[docs]</a>    <span class="k">def</span> <span class="nf">read_its</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">startDateStr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endDateStr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">guess_vals_per_block</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        reads the entire irregular time series record. The timewindow is derived</span>
<span class="sd">        from the D-PART of the pathname so make sure to read that from the catalog</span>
<span class="sd">        before calling this function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pathname_epart</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
        <span class="n">startDateStr</span><span class="p">,</span><span class="n">endDateStr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_times</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">)</span>
        <span class="n">juls</span><span class="p">,</span> <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_datjul</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">)</span>
        <span class="n">jule</span><span class="p">,</span> <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_datjul</span><span class="p">(</span><span class="n">endDateStr</span><span class="p">)</span>
        <span class="n">ietime</span> <span class="o">=</span> <span class="n">istime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># guess how many values to be read based on e part approximation</span>
        <span class="n">ktvals</span> <span class="o">=</span> <span class="n">DSSFile</span><span class="o">.</span><span class="n">_number_between</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">,</span> <span class="n">endDateStr</span><span class="p">,</span> <span class="n">DSSFile</span><span class="o">.</span><span class="n">_get_timedelta_for_interval</span><span class="p">(</span><span class="n">epart</span><span class="p">))</span>
        <span class="n">ktvals</span> <span class="o">=</span> <span class="n">guess_vals_per_block</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">ktvals</span><span class="p">)</span>
        <span class="n">kdvals</span> <span class="o">=</span> <span class="n">ktvals</span>
        <span class="n">itimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ktvals</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">dvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">kdvals</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">inflag</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retrieve both values preceding and following time window in addtion to time window</span>
        <span class="n">nvals</span><span class="p">,</span> <span class="n">ibdate</span><span class="p">,</span> <span class="n">cunits</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zritsxd</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">juls</span><span class="p">,</span> <span class="n">istime</span><span class="p">,</span> <span class="n">jule</span><span class="p">,</span> <span class="n">ietime</span><span class="p">,</span> <span class="n">itimes</span><span class="p">,</span> <span class="n">dvalues</span><span class="p">,</span> <span class="n">inflag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_respond_to_istat_state</span><span class="p">(</span><span class="n">istat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nvals</span> <span class="o">==</span> <span class="n">ktvals</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;More values than guessed! </span><span class="si">%d</span><span class="s2">. Call with guess_vals_per_block &gt; 10000 &quot;</span> <span class="o">%</span> <span class="n">ktvals</span><span class="p">)</span>
        <span class="n">base_date</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="s1">&#39;31DEC1899&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">ibdate</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dvalues</span><span class="p">[:</span><span class="n">nvals</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">base_date</span><span class="o">+</span><span class="n">DSSFile</span><span class="o">.</span><span class="n">timedelta_minutes</span><span class="p">(</span><span class="n">itimes</span><span class="p">[:</span><span class="n">nvals</span><span class="p">]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">pathname</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">cunits</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">ctype</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>
        <span class="c1"># return nvals, dvalues, itimes, base_date, cunits, ctype</span>

<div class="viewcode-block" id="DSSFile.write_its"><a class="viewcode-back" href="../../pyhecdss.html#pyhecdss.pyhecdss.DSSFile.write_its">[docs]</a>    <span class="k">def</span> <span class="nf">write_its</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cunits</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        write irregular time series to the pathname.</span>

<span class="sd">        The timewindow part of the pathname (D PART) is used to establish the base julian date</span>
<span class="sd">        for storage of the time values (minutes relative to that base julian date)</span>

<span class="sd">        The interval is the block size to store irregular time series for efficient access</span>
<span class="sd">        interval values should be &quot;IR-YEAR&quot;, &quot;IR-MONTH&quot; or &quot;IR-DAY&quot;</span>

<span class="sd">        Uses the provided pandas.DataFrame df index (time) and values</span>
<span class="sd">        and also stores the units (cunits) and type (ctype)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">pathname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># parts[5]=DSSFile.FREQ_EPART_MAP[df.index.freq]</span>
        <span class="k">if</span> <span class="n">interval</span><span class="p">:</span>
            <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Specify interval = IR-YEAR or IR-MONTH or IR-DAY or provide it the pathname (5th position)&quot;</span><span class="p">)</span>
        <span class="n">epart</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">startDateStr</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">YearBegin</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">endDateStr</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">YearBegin</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">%b%Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">startDateStr</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">endDateStr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span>
            <span class="n">startDateStr</span> <span class="o">=</span> <span class="n">tw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">endDateStr</span> <span class="o">=</span> <span class="n">tw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># self._pad_to_end_of_block(tw[1],epart)</span>
        <span class="n">juls</span><span class="p">,</span> <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_datjul</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">)</span>
        <span class="n">jule</span><span class="p">,</span> <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_datjul</span><span class="p">(</span><span class="n">endDateStr</span><span class="p">)</span>
        <span class="n">ietime</span> <span class="o">=</span> <span class="n">istime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">itimes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="n">parse</span><span class="p">(</span><span class="n">startDateStr</span><span class="p">)</span>
        <span class="n">itimes</span> <span class="o">=</span> <span class="n">itimes</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span>  <span class="c1"># time in minutes since base date juls</span>
        <span class="n">itimes</span> <span class="o">=</span> <span class="n">itimes</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>  <span class="c1"># conver to integer numpy</span>
        <span class="n">inflag</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># replace data (merging should be done in memory)</span>
        <span class="n">istat</span> <span class="o">=</span> <span class="n">pyheclib</span><span class="o">.</span><span class="n">hec_zsitsxd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifltab</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span>
                                     <span class="n">itimes</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">juls</span><span class="p">,</span> <span class="n">cunits</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">inflag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_respond_to_istat_state</span><span class="p">(</span><span class="n">istat</span><span class="p">)</span></div></div>
        <span class="c1"># return istat</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pyhecdss</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">pyhecdss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/sample_dss_files.html">Sample Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">pyhecdss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">CHANGELOG</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Nicky Sandhu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>